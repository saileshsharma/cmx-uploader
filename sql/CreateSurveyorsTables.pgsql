{"cells":[{"value":"-- Find surveyors who are on shift, not on leave, under capacity, and (optionally) within radius\r\nWITH on_shift AS (\r\n  SELECT st.surveyor_id\r\n  FROM surveyor_shift_template st\r\n  WHERE st.dow = extract(dow FROM :when AT TIME ZONE 'Asia/Singapore')\r\n    AND (cast(:when AT TIME ZONE 'Asia/Singapore' as time)\r\n         BETWEEN st.shift_start AND st.shift_end)\r\n),\r\nnot_on_leave AS (\r\n  SELECT s.id AS surveyor_id\r\n  FROM surveyor s\r\n  WHERE NOT EXISTS (\r\n    SELECT 1 FROM surveyor_unavailability u\r\n    WHERE u.surveyor_id = s.id\r\n      AND tstzrange(u.start_at, u.end_at, '[)') @> :when\r\n  )\r\n),\r\nunder_capacity AS (\r\n  SELECT sdc.surveyor_id\r\n  FROM surveyor_daily_capacity sdc\r\n  JOIN surveyor_state ss ON ss.surveyor_id = sdc.surveyor_id\r\n  WHERE sdc.work_date = (:when AT TIME ZONE 'Asia/Singapore')::date\r\n    AND sdc.assigned_jobs < ss.max_jobs_per_day\r\n),\r\nbase AS (\r\n  SELECT ss.surveyor_id, ss.status, ss.current_jobs,\r\n         ss.last_known_lat, ss.last_known_lng\r\n  FROM surveyor_state ss\r\n  WHERE ss.status IN ('AVAILABLE')   -- strict; relax to include 'BREAK' if you want soft matches\r\n)\r\nSELECT b.surveyor_id,\r\n       b.status,\r\n       b.current_jobs,\r\n       CASE WHEN :lat IS NOT NULL AND :lng IS NOT NULL\r\n            THEN km_distance(:lat, :lng, b.last_known_lat, b.last_known_lng)\r\n            ELSE NULL\r\n       END AS distance_km\r\nFROM base b\r\nJOIN on_shift os       ON os.surveyor_id = b.surveyor_id\r\nJOIN not_on_leave nl   ON nl.surveyor_id = b.surveyor_id\r\nJOIN under_capacity uc ON uc.surveyor_id = b.surveyor_id\r\nWHERE (:radiusKm IS NULL\r\n       OR km_distance(:lat, :lng, b.last_known_lat, b.last_known_lng) <= :radiusKm)\r\nORDER BY distance_km NULLS LAST, b.current_jobs ASC\r\nLIMIT COALESCE(:maxResults, 20);\r\n","kind":"sql","language":"sql"}],"metadata":{"connectionId":"1755479140424","databaseName":"cmx_new_db1","host":"localhost","port":5432,"username":"producer_user","password":"PRODUCER_USER","custom":{"cells":[{"value":"-- Find surveyors who are on shift, not on leave, under capacity, and (optionally) within radius\r\nWITH on_shift AS (\r\n  SELECT st.surveyor_id\r\n  FROM surveyor_shift_template st\r\n  WHERE st.dow = extract(dow FROM :when AT TIME ZONE 'Asia/Singapore')\r\n    AND (cast(:when AT TIME ZONE 'Asia/Singapore' as time)\r\n         BETWEEN st.shift_start AND st.shift_end)\r\n),\r\nnot_on_leave AS (\r\n  SELECT s.id AS surveyor_id\r\n  FROM surveyor s\r\n  WHERE NOT EXISTS (\r\n    SELECT 1 FROM surveyor_unavailability u\r\n    WHERE u.surveyor_id = s.id\r\n      AND tstzrange(u.start_at, u.end_at, '[)') @> :when\r\n  )\r\n),\r\nunder_capacity AS (\r\n  SELECT sdc.surveyor_id\r\n  FROM surveyor_daily_capacity sdc\r\n  JOIN surveyor_state ss ON ss.surveyor_id = sdc.surveyor_id\r\n  WHERE sdc.work_date = (:when AT TIME ZONE 'Asia/Singapore')::date\r\n    AND sdc.assigned_jobs < ss.max_jobs_per_day\r\n),\r\nbase AS (\r\n  SELECT ss.surveyor_id, ss.status, ss.current_jobs,\r\n         ss.last_known_lat, ss.last_known_lng\r\n  FROM surveyor_state ss\r\n  WHERE ss.status IN ('AVAILABLE')   -- strict; relax to include 'BREAK' if you want soft matches\r\n)\r\nSELECT b.surveyor_id,\r\n       b.status,\r\n       b.current_jobs,\r\n       CASE WHEN :lat IS NOT NULL AND :lng IS NOT NULL\r\n            THEN km_distance(:lat, :lng, b.last_known_lat, b.last_known_lng)\r\n            ELSE NULL\r\n       END AS distance_km\r\nFROM base b\r\nJOIN on_shift os       ON os.surveyor_id = b.surveyor_id\r\nJOIN not_on_leave nl   ON nl.surveyor_id = b.surveyor_id\r\nJOIN under_capacity uc ON uc.surveyor_id = b.surveyor_id\r\nWHERE (:radiusKm IS NULL\r\n       OR km_distance(:lat, :lng, b.last_known_lat, b.last_known_lng) <= :radiusKm)\r\nORDER BY distance_km NULLS LAST, b.current_jobs ASC\r\nLIMIT COALESCE(:maxResults, 20);\r\n","kind":"sql","language":"sql"}],"metadata":{"connectionId":"1755479140424","databaseName":"cmx_new_db1","host":"localhost","port":5432,"username":"producer_user","password":"PRODUCER_USER","custom":{"cells":[],"metadata":{"connectionId":"1755479140424","databaseName":"cmx_new_db1","host":"localhost","port":5432,"username":"producer_user","password":"PRODUCER_USER","custom":{"cells":[{"value":"# Create New Table in Schema: public\n\nModify the definition below and execute the cell to create the table.","kind":"sql","language":"sql"},{"value":"CREATE TABLE surveyor_availability (\n    id BIGSERIAL PRIMARY KEY,\n    surveyor_id BIGINT NOT NULL REFERENCES surveyor(id),\n    status VARCHAR(20) NOT NULL,          -- AVAILABLE, BUSY, OFFLINE\n    current_jobs INT DEFAULT 0,\n    max_jobs_per_day INT DEFAULT 5,\n    last_updated TIMESTAMP DEFAULT now()\n);\n\nCREATE TABLE surveyor_schedule (\n    id BIGSERIAL PRIMARY KEY,\n    surveyor_id BIGINT NOT NULL REFERENCES surveyor(id),\n    work_day DATE NOT NULL,\n    shift_start TIME,\n    shift_end TIME,\n    is_holiday BOOLEAN DEFAULT FALSE\n);","kind":"sql","language":"sql"}],"metadata":{"connectionId":"1755479140424","databaseName":"cmx_new_db1","host":"localhost","port":5432,"username":"producer_user","password":"PRODUCER_USER","custom":{"cells":[],"metadata":{"connectionId":"1755479140424","databaseName":"cmx_new_db1","host":"localhost","port":5432,"username":"producer_user","password":"PRODUCER_USER","custom":{"cells":[{"value":"# Create New Table in Schema: public\n\nModify the definition below and execute the cell to create the table.","kind":"markdown","language":"markdown"},{"value":"CREATE TABLE surveyor_availability (\n    id BIGSERIAL PRIMARY KEY,\n    surveyor_id BIGINT NOT NULL REFERENCES surveyor(id),\n    status VARCHAR(20) NOT NULL,          -- AVAILABLE, BUSY, OFFLINE\n    current_jobs INT DEFAULT 0,\n    max_jobs_per_day INT DEFAULT 5,\n    last_updated TIMESTAMP DEFAULT now()\n);\n\nCREATE TABLE surveyor_schedule (\n    id BIGSERIAL PRIMARY KEY,\n    surveyor_id BIGINT NOT NULL REFERENCES surveyor(id),\n    work_day DATE NOT NULL,\n    shift_start TIME,\n    shift_end TIME,\n    is_holiday BOOLEAN DEFAULT FALSE\n);","kind":"sql","language":"sql"}],"metadata":{"connectionId":"1755479140424","databaseName":"cmx_new_db1","host":"localhost","port":5432,"username":"producer_user","password":"PRODUCER_USER","custom":{"cells":[],"metadata":{"connectionId":"1755479140424","databaseName":"cmx_new_db1","host":"localhost","port":5432,"username":"producer_user","password":"PRODUCER_USER","enableScripts":true}},"enableScripts":true}},"enableScripts":true}},"enableScripts":true}},"enableScripts":true}},"enableScripts":true}}}}